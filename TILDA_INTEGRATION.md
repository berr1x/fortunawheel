# Интеграция с Tilda

## Обзор

Система интегрирована с Tilda для обработки покупок и автоматического создания сессий прокруток колеса фортуны.

## Логика расчета прокруток

**Формула:** `количество_прокруток = Math.floor(сумма_покупки / 3000)`

### Примеры:
- 1500 рублей → 0 прокруток
- 3000 рублей → 1 прокрутка  
- 6000 рублей → 2 прокрутки
- 9000 рублей → 3 прокрутки
- 10000 рублей → 3 прокрутки (остаток 1000 рублей не учитывается)

## Webhook Endpoint

**URL:** `POST /api/tilda/webhook`

### Входящие данные (обязательные поля):
```json
{
  "email": "user@example.com",     // Email покупателя
  "amount": 9000,                  // Сумма покупки в рублях
  "order_id": "order_12345"        // Уникальный ID заказа
}
```

### Ответ при успехе:
```json
{
  "success": true,
  "message": "Purchase processed successfully",
  "sessionId": 123,
  "spinsEarned": 3,
  "userId": 456
}
```

### Ответ при отсутствии прокруток:
```json
{
  "success": true,
  "message": "Purchase processed but no spins earned",
  "spinsEarned": 0
}
```

## Процесс обработки

1. **Валидация данных** - проверка обязательных полей
2. **Расчет прокруток** - по формуле суммы/3000
3. **Поиск/создание пользователя** - по email
4. **Создание записи покупки** - с количеством прокруток
5. **Создание сессии прокруток** - только если прокруток > 0

## Логика сессий прокруток

### Получение сессии (`GET /api/wheel/session`)

**Поведение:**
- Если пользователь **не существует** → `success: false, message: "Пользователь не найден. Сначала совершите покупку через Tilda."`
- Если пользователь **существует, но нет покупок** → `success: false, message: "У вас нет доступных прокруток. Совершите покупку через Tilda."`
- Если пользователь **существует и есть покупки** → `success: true, sessionId: "123", spinsRemaining: 2`

**Важно:** Сессии создаются только на основе реальных покупок через Tilda webhook!

## Обработка ошибок

- **400 Bad Request** - неверные данные webhook'а
- **500 Internal Server Error** - ошибка сервера

## Тестирование

Запустите тестовый скрипт:
```bash
node test-tilda-webhook.js
```

Скрипт проверит различные сценарии покупок и корректность расчета прокруток.

## Логирование

Все операции логируются с уровнем INFO:
- Получение webhook'а
- Обработка покупки
- Создание пользователя/сессии
- Ошибки обработки

## Безопасность

- Валидация всех входящих данных
- Транзакционность операций с БД
- Логирование для аудита
- Обработка дублирующихся заказов (по order_id)