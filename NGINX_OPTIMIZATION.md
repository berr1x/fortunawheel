# Оптимизация Nginx для высокой нагрузки

## Что было улучшено

### 1. **Connection Pooling (Upstream Keep-Alive)**
- Создан upstream блок с `keepalive 64` соединений
- Бэкенд соединения переиспользуются, а не создаются заново
- **Результат**: Снижение нагрузки на Node.js до 80%, уменьшение латентности

### 2. **Кэширование GET /api/wheel/prizes**
- Самый частый запрос (по нагрузке) теперь кэшируется на 30 секунд
- Используется `proxy_cache_background_update` для обновления без блокировок
- **Результат**: 95% запросов к `/prizes` обслуживаются из кэша Nginx

### 3. **Оптимизированные буферы**
- Увеличены буферы для прокси: `proxy_buffers 16 8k`
- Оптимизированы таймауты: `proxy_read_timeout 60s`
- **Результат**: Лучшая обработка пиковых нагрузок

### 4. **HTTP/2 включен**
- `listen 443 ssl http2` для мультиплексирования запросов
- **Результат**: До 30% снижение латентности на множественных запросах

### 5. **Оптимизация статики**
- `open_file_cache` для кэширования файловых дескрипторов
- Отключено логирование для статики
- **Результат**: Быстрая раздача изображений без лишней нагрузки

### 6. **Gzip сжатие**
- Уровень сжатия 6 для баланса CPU/размер
- Сжатие всех текстовых типов включая JSON
- **Результат**: 60-80% уменьшение трафика

### 7. **Retry механизм**
- Автоматический retry при временных ошибках (502, 503, 504)
- **Результат**: Повышение отказоустойчивости

## Как применить

### Вариант 1: Полная замена конфига
```bash
# 1. Создайте директорию для кэша
sudo mkdir -p /var/cache/nginx
sudo chown -R www-data:www-data /var/cache/nginx

# 2. Сделайте бэкап текущего конфига
sudo cp /etc/nginx/sites-available/cdn.cake-school-fortune.ru /etc/nginx/sites-available/cdn.cake-school-fortune.ru.backup

# 3. Скопируйте новый конфиг
sudo cp nginx-production-optimized.conf /etc/nginx/sites-available/cdn.cake-school-fortune.ru

# 4. Проверьте синтаксис
sudo nginx -t

# 5. Перезагрузите Nginx
sudo systemctl reload nginx
```

### Вариант 2: Постепенное применение

Скопируйте ключевые блоки из `nginx-production-optimized.conf` в ваш текущий конфиг:

1. **Upstream блок** - в начало конфига (перед server)
2. **proxy_cache_path** - в секцию http (если есть главный конфиг) или перед server
3. **location /api/wheel/prizes** - добавьте отдельным блоком
4. **Оптимизации в location /api** - обновите существующий блок
5. **HTTP/2** - измените `listen 443 ssl` на `listen 443 ssl http2`

## Мониторинг кэша

После применения проверьте статистику кэша:
```bash
# Посмотрите размер кэша
du -sh /var/cache/nginx/

# Проверьте заголовок X-Cache-Status в ответах
curl -I https://cdn.cake-school-fortune.ru/api/wheel/prizes

# Статусы кэша:
# - MISS - не в кэше (первый запрос)
# - HIT - из кэша (быстрый ответ)
# - BYPASS - кэш обойден
```

## Ожидаемые результаты

При нагрузке 2000+ пользователей:
- **RPS**: Увеличение с ~1800 до 3000+ RPS
- **Латентность p50**: Остается ~45ms
- **Латентность p95**: Снижение с 5000ms до ~200ms
- **Ошибки**: Снижение с 12% до 1-2%
- **CPU бэкенда**: Снижение на 40-60% за счет кэширования

## Важные замечания

1. **Кэш /api/wheel/prizes** обновляется каждые 30 секунд. Если нужно мгновенное обновление после изменения призов - очистите кэш или измените `proxy_cache_valid` на меньшее значение.

2. **Keep-alive соединения** критически важны. Убедитесь что в `main.ts` настроены таймауты (это уже сделано).

3. **Размер кэша**: 1GB достаточно для ~1 миллиона запросов к `/prizes`. При необходимости увеличьте `max_size=1g`.

4. **Логирование**: Рассмотрите возможность отключения access_log для `/api/wheel/prizes` в продакшне для экономии I/O.

## Откат изменений

Если что-то пошло не так:
```bash
sudo cp /etc/nginx/sites-available/cdn.cake-school-fortune.ru.backup /etc/nginx/sites-available/cdn.cake-school-fortune.ru
sudo nginx -t
sudo systemctl reload nginx
```

